WITH base AS (
  SELECT
      EXTRACT(year FROM MONTH)::INT AS yr

    , ORIGIN
    , DESTINATION
    , AIRCRAFT

 
    , PASSENGERS
    , FLIGHTS
    , ASMS
    , (PASSENGERS * MILES_DISTANCE) AS rpms

  
    , (FIRST_CLASS_REVENUE + PREM_ECONOMY_REVENUE) AS premium_revenue

    -- passenger revenue (EXCLUDES freight)
    , (
          FIRST_CLASS_REVENUE
        + PREM_ECONOMY_REVENUE
        + ECONOMY_REVENUE
        + BAGGAGE_REVENUE
        + OTHER_ANCILLARY_REVENUE
      ) AS pax_revenue

    -- total revenue (INCLUDES freight) 
    , (
          FIRST_CLASS_REVENUE
        + PREM_ECONOMY_REVENUE
        + ECONOMY_REVENUE
        + BAGGAGE_REVENUE
        + OTHER_ANCILLARY_REVENUE
        + FREIGHT_REVENUE
      ) AS total_revenue

 
    , (
          AIRCRAFT_OPERATION_COST
        + AIRPORT_FEE_COST
        + CREW_AND_LABOR_COST
        + FUEL_COST
      ) AS total_cost

    , (
          AIRCRAFT_OPERATION_COST
        + AIRPORT_FEE_COST
        + CREW_AND_LABOR_COST
      ) AS total_cost_ex_fuel


    , (
          (FIRST_CLASS_REVENUE
         + PREM_ECONOMY_REVENUE
         + ECONOMY_REVENUE
         + BAGGAGE_REVENUE
         + OTHER_ANCILLARY_REVENUE
         + FREIGHT_REVENUE)
        - (AIRCRAFT_OPERATION_COST
         + AIRPORT_FEE_COST
         + CREW_AND_LABOR_COST
         + FUEL_COST)
      ) AS profit
  FROM my_db.main.ca_candidate_project_data
  --sanity checking below
  ---WHERE 
  --ORIGIN = 'OGG'
  --  AND DESTINATION = 'HNL'
  -- AND AIRCRAFT = 'A321'
),

yearly AS (
  SELECT
      yr


    , COUNT(DISTINCT ORIGIN) AS unique_origin_cities
    , COUNT(DISTINCT DESTINATION) AS unique_destination_cities
    , COUNT(DISTINCT ORIGIN) + COUNT(DISTINCT DESTINATION) AS unique_cities_simple
    , COUNT(DISTINCT (ORIGIN || '->' || DESTINATION)) AS unique_origin_destination_routes
    , COUNT(DISTINCT (ORIGIN || '->' || DESTINATION || '|' || AIRCRAFT)) AS unique_od_aircraft_combinations
    , COUNT(DISTINCT AIRCRAFT) AS unique_aircraft_types


    , SUM(total_revenue) AS yearly_revenue
    , SUM(total_cost) AS yearly_expenses
    , SUM(PASSENGERS) AS yearly_passengers
    , SUM(total_revenue) - SUM(total_cost) AS yearly_profitability

    -- flight-level unprofitable share (weighted by FLIGHTS)
    , SUM(CASE WHEN profit < 0 THEN FLIGHTS ELSE 0 END) * 1.0
        / NULLIF(SUM(FLIGHTS), 0) AS pct_yearly_unprofitable_flights

    -- unit economics
    , SUM(total_revenue) * 1.0 / NULLIF(SUM(ASMS), 0) AS yearly_rasm
    , SUM(total_cost) * 1.0 / NULLIF(SUM(ASMS), 0) AS yearly_casm
    , SUM(total_cost_ex_fuel) * 1.0 / NULLIF(SUM(ASMS), 0) AS yearly_casm_ex_fuel

    -- load factor (RPM / ASM)
    , SUM(rpms) * 1.0 / NULLIF(SUM(ASMS), 0) AS yearly_load_factor
    , (SUM(rpms) * 1.0 / NULLIF(SUM(ASMS), 0)) * 100 AS yearly_load_factor_pct

    -- premium revenue
    , SUM(premium_revenue) AS yearly_premium_revenue

    -- lost revenue (note that I'm using only passenger revenue - no freight)
    , (SUM(pax_revenue) * 1.0 * SUM(ASMS) / NULLIF(SUM(rpms), 0))
        - SUM(pax_revenue) AS yearly_lost_revenue

    -- yield
    , SUM(total_revenue) * 1.0 / NULLIF(SUM(rpms), 0) AS yearly_yield
  FROM base
  GROUP BY 1
),

od_aircraft_yearly AS (
  SELECT
      yr
    , ORIGIN
    , DESTINATION
    , AIRCRAFT
    , SUM(total_revenue) AS rev
    , SUM(total_cost) AS cost
  FROM base
  GROUP BY 1,2,3,4
)

SELECT
    y.yr


  , y.unique_origin_cities
  , y.unique_destination_cities
  , y.unique_cities_simple
  , y.unique_origin_destination_routes
  , y.unique_od_aircraft_combinations
  , y.unique_aircraft_types


  , y.yearly_revenue
  , y.yearly_expenses
  , y.yearly_passengers
  , y.yearly_profitability

  -- % of yearly unprofitable ODâ€“Aircraft combinations
  , (
      SELECT
        COUNT(*) FILTER (WHERE rev < cost) * 1.0 / NULLIF(COUNT(*), 0)
      FROM od_aircraft_yearly o
      WHERE o.yr = y.yr
    ) AS pct_yearly_unprofitable_od_aircraft_combinations

  -- % of yearly unprofitable flights
  , y.pct_yearly_unprofitable_flights

  -- unit economics
  , y.yearly_rasm
  , y.yearly_casm
  , y.yearly_casm_ex_fuel

    -- load factor
  , y.yearly_load_factor
  , y.yearly_load_factor_pct

  -- premium and lost revenue
  , y.yearly_premium_revenue
  , y.yearly_lost_revenue

  -- yield
  , y.yearly_yield
FROM yearly y
ORDER BY y.yr;
